# Документация проекта
## Оглавление
1. [Описание логики работы](#описание-логики-работы)
2. [Установка](#установка-модуля)
3. [Опции](#опции-модуля)
4. [Настройка крон ивента и скрипта](#настройка-крон-ивента-и-скрипта)
5. [Важное](#важное)


## Описание логики работы

При устанлвке модуля, в карточку Лида добавляется пользовательское поле Идентификатор.

При создании и изменении лида, происходит проверка соответствия корректности заполнения данного поля по формату (4 любые буквы минус 4 любые цифры).

Если поле не соответсвует формату выводится всплывающее сообщение об ошибке

Значение поля Идентификатор:
Пример: DNRY-2345 (4 любые буквы минус 4 любые цифры)

Реализован php-скрипт запускаемый непосредственно из консоли BASH который запишет в текстовый файл текущее время и суммарное количество лидов в системе на данный момент.
Этот скрипт при правильной установке по инструкции запускается на кроне 1 раз в 15 минут и дописывает в файл время и количество лидов.



## Установка модуля
* Для установки модуля необходимо поместить файлы модуля в папку `/local/modules/`
* Далее зайти в административной панели по пути `Рабочий стол -> Marketplace -> Установленные решения`
* Найти модуль  `paul.leadschecker` и начать его установку
* После установки модуля перейдите в настройки модуля и нажмите кнопку применить/apply,  чтобы настройки применились.
   Путь - `Настройки -> Настройки продукта -> Настройки модулей -> Paul leadschecker Модуль`


После установки модуля новое поле Идентификатор будет создано и помещено в ЛИДЫ.  При удалении модуля поле будет удалено

## Опции модуля

В опциях модуля по дефолту устанавливается код нового поля. 
Если код в опциях модуля заменить, 
тогда проверке (4 буквы минус 4 цифры) будет подвергаться
значение того поля, которое установлено. Если поле не будет найдено - лид будет сохраняться в обычном режиме


##  Настройка крон ивента и скрипта

1. Для начала  необходимо создать входящий
вебхук в публичной части сайта который находится в  пункте ЛЕВОГО меню

`Приложения -> Разработчикам -> Другое ` или по пути ` ваш Домен/devops/section/standard/`

После того как вы открыли этот путь нужно кликнуть на `Входящий вебхук`


2. Далее заполнение параметров для создание веб хука

Метод - crm.lead.list 

Настройка прав - CRM

3. Далее копируете строку в параметре URL  у нее будет примерно такой вид https://testb24:8890/rest/1/6jbm1vogmer9o1d4/crm.lead.list.json
4. Далее в файловой системе необходимо перейти по пути `local/modules/paul.leadschecker/cron/lead_count_script.php`
И заменить следующие переменные:

```php

$webhookUrl = "https://testb24:8890/rest/1/6jbm1vogmer9o1d4/crm.lead.list.json"; // в Эту переменную нужно вставить ваш вебхук
$logFile = '<ВАШ Абсолютный путь до проекта>/testb24/local/leads_count_log.txt'; //  В эту переменную полный путь где будет находиться файл логов


```

5. Теперь нужно Добавить запись в cron 
 - Зайдите в консоль BASH своего сервера
 - Откройте crontab командой `crontab -e`
 - В открывшемся VIM редакторе добавьте запись `*/15 * * * * /usr/bin/php <ВАШ Абсолютный путь до проекта>/local/modules/paul.leadschecker/cron/lead_count_script.php`
 - Замените <ВАШ Абсолютный путь до проекта> на ваш путь до проекта на сервере.
 - Командой `crontab -l` проверьте записи в кроне. Там должена быть наша новая запись
 - Перезапустите крон

## ВАЖНОЕ
* `/Users/pavelbalaganskij/projects/testb24` - пример моего абсолютного пути   **!Обязательно замените абсолютный путь до проекта!**
* `/usr/bin/php` -  **!Убедитесь, что на вашей системе интерпретатор PHP находится именно по этому пути!**
* Убедитесь что крон запущен и работает корректно
* **На сервере должен быть установлен PHP 8.3 для корректной работы модуля**
* **Должен быть включен Curl**




